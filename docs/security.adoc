= Global Security Configuration
:toc:
:toc-title:
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

== Overview

=== Authentication

Swarm may be used with either a https://www.jenkins.io/blog/2018/07/02/new-api-token-system/[Jenkins API token] (recommended) or a password.
The following command-line options control authentication:

`-username`:: The Jenkins username for authentication.
`-password`:: The Jenkins user API token or password.
`-passwordEnvVariable`:: Environment variable containing the Jenkins user API token or password.
`-passwordFile`:: File containing the Jenkins user API token or password.

NOTE: When using a password, the Swarm client will automatically obtain a valid https://support.cloudbees.com/hc/en-us/articles/219257077-CSRF-Protection-Explained[CSRF crumb] when making requests.

=== Authorization

Swarm requires a user with the following permissions:

* *Overall/Read*
* *Agent/Create*
* *Agent/Connect*
* *Agent/Configure* (_not_ required when using the project-based Matrix Authorization Strategy)

== Examples

=== Matrix-based security

A common practice is to grant *Overall/Read* permission to either anonymous or authenticated users, leaving the dedicated Swarm user with only *Agent/Create*, *Agent/Connect*, and *Agent/Configure* permissions:

image:images/matrixBasedSecurity.png[image]

=== Project-based Matrix Authorization Strategy

A common practice is to grant *Overall/Read* permission to either anonymous or authenticated users, leaving the dedicated Swarm user with only *Agent/Create* and *Agent/Connect* permissions:

image:images/projectBasedMatrixAuthorizationStrategy.png[image]

NOTE: Unlike matrix-based security, the project-based Matrix Authorization Strategy does not require *Agent/Configure* permission.

=== Role-Based Strategy

A common practice is to create a read-only role with *Overall/Read* permission, leaving a dedicated Swarm role with only *Agent/Create*, *Agent/Connect*, and *Agent/Configure* permissions:

image:images/roleBasedStrategyManage.png[image]

The read-only role can then be assigned to either anonymous or authenticated users, leaving the dedicated Swarm role for Swarm users only:

image:images/roleBasedStrategyAssign.png[image]

== Caveats and Troubleshooting

A single Jenkins controller currenly supports a single selection from a multitude of possible authentication providers. If your Jenkins deployment outgrows locally-defined accounts and switches to an external database, such as LDAP, Github or Google authentication, you would have to define there not only team member accounts, but also some for your Swarm agents to use.

=== GitHub Authentication plugin

As tracked in link:https://issues.jenkins.io/browse/JENKINS-63421 currently the Autorization Strategy delivered as an optional part of the GitHub Authentication plugin (github-oauth-plugin) lacks a way to assign *Agent/...* permissions. Due to this, currently you would have to define a Matrix-based or Project-based Matrix strategy as detailed above, and use the account (and group/organization) names provided and confirmed by the Authentication part. Note this can forfeit some benefits compared to native stragegy provided by the plugin: not sure the matrix setup can go into such detail as github-oauth-plugin natively can -- e.g. considering PR authors, collaborators, contributors... as special groups).

It was verified that swarm clients can connect with a new Github account not attached to any organization, after generating a token for it with "read:user" and "read:org" permissions, and passing it in one of the `-password*` CLI options for the Swarm agent JAR startup.

As part of verification, it was not possible to authenticate the swarm client with an account defined only locally on the Jenkins controller with a password (since the local database was no longer selected to be used for authentication), although this account is otherwise known and manageable in Jenkins UI.

Note that API auth directly by password no longer works on Github side since 2020, only by tokens. On an upside, this allows to issue (and pull back) many tokens for many build agents using the same account.

The account was kept outside the Github organization so it has no rights there by accident or security breach. Also the Matrix-based security configuration in the tested setup allowed any members of the specified organization various permissions for the Jenkins jobs and other objects, which an account used purely for agent connections does not need.

On Jenkins controller side, authorization strategy had to be switched from GitHub strategy to a manually made somewhat similar matrix (which sufficed for test project's static list of Github organizations and teams of admin accounts), and that new account was granted the permissions needed for Swarm client.

It was also double-checked that with the worker machine isolated by firewall, so it can not access the Internet and can only talk to the Jenkins controller (in the same subnet), Github authentication still works -- so it is not the client that has to go to Github and back to confirm the account.
